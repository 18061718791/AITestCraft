<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocketè¿æ¥è¯Šæ–­</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .log {
            background: #f8f8f8;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” WebSocketè¿æ¥è¯Šæ–­å·¥å…·</h1>
        <p>æ­¤å·¥å…·å°†å¸®åŠ©è¯Šæ–­WebSocketè¿æ¥é—®é¢˜</p>
        
        <div>
            <button onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
            <button onclick="testBasicConnectivity()">æµ‹è¯•åŸºç¡€è¿æ¥</button>
            <button onclick="testWebSocket()">æµ‹è¯•WebSocket</button>
            <button onclick="testSocketIO()">æµ‹è¯•Socket.IO</button>
            <button onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
        </div>
        
        <div id="results"></div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const resultsDiv = document.getElementById('results');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log ${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            resultsDiv.appendChild(logEntry);
            
            // æ»šåŠ¨åˆ°æœ€æ–°æ—¥å¿—
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
        
        function addResult(title, content, type = 'info') {
            const resultDiv = document.createElement('div');
            resultDiv.className = 'test-result';
            resultDiv.innerHTML = `
                <h4 class="${type}">${title}</h4>
                <div>${content}</div>
            `;
            resultsDiv.appendChild(resultDiv);
        }
        
        function clearLogs() {
            resultsDiv.innerHTML = '';
        }
        
        async function testBasicConnectivity() {
            log('å¼€å§‹æµ‹è¯•åŸºç¡€ç½‘ç»œè¿æ¥...', 'info');
            
            try {
                // æµ‹è¯•HTTPè¿æ¥
                const response = await fetch('http://120.55.187.125:9000/socket.io/?EIO=4&transport=polling');
                
                addResult(
                    'HTTPè¿æ¥æµ‹è¯•',
                    `çŠ¶æ€ç : ${response.status}<br>
                     å“åº”å¤´: ${JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2)}`,
                    response.ok ? 'success' : 'error'
                );
                
                if (response.ok) {
                    const data = await response.text();
                    log('HTTPè¿æ¥æˆåŠŸï¼Œå“åº”æ•°æ®: ' + data.substring(0, 100) + '...', 'success');
                }
                
            } catch (error) {
                addResult('HTTPè¿æ¥æµ‹è¯•', `é”™è¯¯: ${error.message}`, 'error');
                log('HTTPè¿æ¥å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        function testWebSocket() {
            log('å¼€å§‹æµ‹è¯•åŸç”ŸWebSocketè¿æ¥...', 'info');
            
            try {
                const ws = new WebSocket('ws://120.55.187.125:9000');
                
                ws.onopen = () => {
                    addResult('åŸç”ŸWebSocketæµ‹è¯•', 'è¿æ¥æˆåŠŸå»ºç«‹', 'success');
                    log('åŸç”ŸWebSocketè¿æ¥æˆåŠŸ', 'success');
                    ws.close();
                };
                
                ws.onerror = (error) => {
                    addResult('åŸç”ŸWebSocketæµ‹è¯•', `è¿æ¥é”™è¯¯: ${error.type}`, 'error');
                    log('åŸç”ŸWebSocketè¿æ¥é”™è¯¯: ' + error.type, 'error');
                };
                
                ws.onclose = (event) => {
                    addResult('åŸç”ŸWebSocketæµ‹è¯•', 
                        `è¿æ¥å…³é—­ - ä»£ç : ${event.code}, åŸå› : ${event.reason}`, 
                        'warning'
                    );
                    log(`WebSocketè¿æ¥å…³é—­ - ä»£ç : ${event.code}`, 'warning');
                };
                
            } catch (error) {
                addResult('åŸç”ŸWebSocketæµ‹è¯•', `åˆ›å»ºé”™è¯¯: ${error.message}`, 'error');
                log('åˆ›å»ºWebSocketæ—¶å¼‚å¸¸: ' + error.message, 'error');
            }
        }
        
        function testSocketIO() {
            log('å¼€å§‹æµ‹è¯•Socket.IOè¿æ¥...', 'info');
            
            try {
                const socket = io('http://120.55.187.125:9000', {
                    transports: ['websocket', 'polling'],
                    timeout: 10000,
                    reconnection: false,
                    withCredentials: true,
                    forceNew: true
                });
                
                socket.on('connect', () => {
                    addResult('Socket.IOæµ‹è¯•', 
                        `è¿æ¥æˆåŠŸ - ID: ${socket.id}`, 
                        'success'
                    );
                    log('Socket.IOè¿æ¥æˆåŠŸï¼ŒID: ' + socket.id, 'success');
                    socket.disconnect();
                });
                
                socket.on('connect_error', (error) => {
                    addResult('Socket.IOæµ‹è¯•', 
                        `è¿æ¥é”™è¯¯: ${error.message}<br>
                         é”™è¯¯ç±»å‹: ${error.type || 'unknown'}<br>
                         ä¼ è¾“æ–¹å¼: ${error.transport || 'unknown'}`, 
                        'error'
                    );
                    log('Socket.IOè¿æ¥é”™è¯¯: ' + error.message, 'error');
                });
                
                socket.on('error', (error) => {
                    addResult('Socket.IOæµ‹è¯•', `é”™è¯¯: ${error.message || error}`, 'error');
                    log('Socket.IOé”™è¯¯: ' + (error.message || error), 'error');
                });
                
                socket.on('disconnect', (reason) => {
                    addResult('Socket.IOæµ‹è¯•', `æ–­å¼€è¿æ¥åŸå› : ${reason}`, 'warning');
                    log('Socket.IOæ–­å¼€è¿æ¥: ' + reason, 'warning');
                });
                
                // 10ç§’åå¼ºåˆ¶æ–­å¼€
                setTimeout(() => {
                    if (socket.connected) {
                        socket.disconnect();
                    }
                }, 10000);
                
            } catch (error) {
                addResult('Socket.IOæµ‹è¯•', `åˆ›å»ºé”™è¯¯: ${error.message}`, 'error');
                log('åˆ›å»ºSocket.IOæ—¶å¼‚å¸¸: ' + error.message, 'error');
            }
        }
        
        async function runAllTests() {
            clearLogs();
            log('å¼€å§‹è¿è¡Œæ‰€æœ‰è¯Šæ–­æµ‹è¯•...', 'info');
            
            // æ˜¾ç¤ºæµè§ˆå™¨ä¿¡æ¯
            addResult('æµè§ˆå™¨ä¿¡æ¯', 
                `ç”¨æˆ·ä»£ç†: ${navigator.userAgent}<br>
                 è¯­è¨€: ${navigator.language}<br>
                 åœ¨çº¿çŠ¶æ€: ${navigator.onLine ? 'åœ¨çº¿' : 'ç¦»çº¿'}<br>
                 åè®®: ${window.location.protocol}<br>
                 ä¸»æœº: ${window.location.host}`, 
                'info'
            );
            
            // æŒ‰é¡ºåºè¿è¡Œæµ‹è¯•
            await testBasicConnectivity();
            setTimeout(() => testWebSocket(), 1000);
            setTimeout(() => testSocketIO(), 2000);
            
            setTimeout(() => {
                log('æ‰€æœ‰æµ‹è¯•å®Œæˆ', 'info');
            }, 12000);
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒåŸºç¡€æµ‹è¯•
        window.addEventListener('load', () => {
            log('WebSocketè¯Šæ–­å·¥å…·å·²åŠ è½½', 'info');
            log('ç‚¹å‡»"è¿è¡Œæ‰€æœ‰æµ‹è¯•"å¼€å§‹è¯Šæ–­', 'info');
        });
    </script>
</body>
</html>